name: Build APK

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-apk:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - uses: android-actions/setup-android@v3

      - uses: gradle/actions/setup-gradle@v4

      - name: Create project
        run: |
          mkdir -p android/app/src/main/java/com/magicclock/app
          mkdir -p android/app/src/main/res/values
          mkdir -p android/app/src/main/res/mipmap-hdpi
          mkdir -p android/app/src/main/res/mipmap-xhdpi
          mkdir -p android/app/src/main/res/mipmap-xxhdpi
          mkdir -p android/app/src/main/res/mipmap-xxxhdpi
          cp assets/icon-192.png android/app/src/main/res/mipmap-hdpi/ic_launcher.png
          cp assets/icon-192.png android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
          cp assets/icon-512.png android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
          cp assets/icon-512.png android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png

      - name: Generate keystore
        run: |
          keytool -genkeypair -alias mc -keyalg RSA -keysize 2048 \
            -validity 10000 -keystore android/keystore.jks \
            -storepass clock123 -keypass clock123 \
            -dname "CN=MagicClock,O=MagicClock,L=Madrid,C=ES"

      - name: Write Gradle files
        run: |
          cat > android/settings.gradle << 'EOF'
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
              }
          }
          rootProject.name = "MagicClock"
          include ':app'
          EOF

          cat > android/build.gradle << 'EOF'
          plugins {
              id 'com.android.application' version '8.2.0' apply false
          }
          EOF

          cat > android/app/build.gradle << 'EOF'
          plugins {
              id 'com.android.application'
          }
          android {
              namespace 'com.magicclock.app'
              compileSdk 34
              defaultConfig {
                  applicationId "com.magicclock.app"
                  minSdk 24
                  targetSdk 34
                  versionCode 1
                  versionName "1.0.0"
              }
              signingConfigs {
                  release {
                      storeFile file("../keystore.jks")
                      storePassword "clock123"
                      keyAlias "mc"
                      keyPassword "clock123"
                  }
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                      minifyEnabled false
                  }
              }
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
              lint {
                  abortOnError false
              }
          }
          dependencies {
              implementation 'androidx.webkit:webkit:1.8.0'
          }
          EOF

      - name: Write Android sources
        run: |
          cat > android/app/src/main/AndroidManifest.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <uses-permission android:name="android.permission.INTERNET"/>
              <uses-permission android:name="android.permission.WAKE_LOCK"/>
              <application
                  android:icon="@mipmap/ic_launcher"
                  android:label="MagicClock"
                  android:theme="@style/AppTheme"
                  android:usesCleartextTraffic="false">
                  <activity
                      android:name=".MainActivity"
                      android:exported="true"
                      android:screenOrientation="portrait"
                      android:configChanges="orientation|screenSize|keyboard|keyboardHidden">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN"/>
                          <category android:name="android.intent.category.LAUNCHER"/>
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF

          cat > android/app/src/main/res/values/styles.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <style name="AppTheme" parent="android:Theme.DeviceDefault.NoActionBar">
                  <item name="android:windowFullscreen">true</item>
                  <item name="android:windowNoTitle">true</item>
                  <item name="android:windowBackground">#FF000000</item>
                  <item name="android:statusBarColor">#00000000</item>
                  <item name="android:navigationBarColor">#FF000000</item>
              </style>
          </resources>
          EOF

          cat > android/app/src/main/java/com/magicclock/app/MainActivity.java << 'JAVAEOF'
          package com.magicclock.app;

          import android.app.Activity;
          import android.content.Intent;
          import android.graphics.Color;
          import android.net.Uri;
          import android.os.Build;
          import android.os.Bundle;
          import android.view.View;
          import android.view.Window;
          import android.view.WindowManager;
          import android.webkit.ValueCallback;
          import android.webkit.WebChromeClient;
          import android.webkit.WebSettings;
          import android.webkit.WebView;
          import android.webkit.WebViewClient;

          @SuppressWarnings("deprecation")
          public class MainActivity extends Activity {
              private WebView webView;
              private ValueCallback<Uri[]> uploadCb;
              private static final int PICK = 1;
              private static final String URL = "https://mario1988123.github.io/timelinev2/";

              @Override
              protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  requestWindowFeature(Window.FEATURE_NO_TITLE);
                  Window w = getWindow();
                  w.setFlags(WindowManager.LayoutParams.FLAG_FULLSCREEN,
                             WindowManager.LayoutParams.FLAG_FULLSCREEN);
                  w.addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);
                  if (Build.VERSION.SDK_INT >= 28) {
                      w.getAttributes().layoutInDisplayCutoutMode = 1;
                  }

                  webView = new WebView(this);
                  webView.setBackgroundColor(Color.BLACK);
                  setContentView(webView);
                  goImmersive();

                  WebSettings s = webView.getSettings();
                  s.setJavaScriptEnabled(true);
                  s.setDomStorageEnabled(true);
                  s.setDatabaseEnabled(true);
                  s.setAllowFileAccess(true);
                  s.setCacheMode(WebSettings.LOAD_DEFAULT);
                  s.setMediaPlaybackRequiresUserGesture(false);

                  webView.setWebViewClient(new WebViewClient());
                  webView.setWebChromeClient(new WebChromeClient() {
                      @Override
                      public boolean onShowFileChooser(WebView wv,
                              ValueCallback<Uri[]> cb,
                              WebChromeClient.FileChooserParams p) {
                          if (uploadCb != null) uploadCb.onReceiveValue(null);
                          uploadCb = cb;
                          try {
                              startActivityForResult(p.createIntent(), PICK);
                          } catch (Exception e) {
                              uploadCb = null;
                              return false;
                          }
                          return true;
                      }
                  });
                  webView.loadUrl(URL);
              }

              private void goImmersive() {
                  getWindow().getDecorView().setSystemUiVisibility(
                      View.SYSTEM_UI_FLAG_LAYOUT_STABLE
                      | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION
                      | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN
                      | View.SYSTEM_UI_FLAG_HIDE_NAVIGATION
                      | View.SYSTEM_UI_FLAG_FULLSCREEN
                      | View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY);
              }

              @Override
              public void onWindowFocusChanged(boolean hasFocus) {
                  super.onWindowFocusChanged(hasFocus);
                  if (hasFocus) goImmersive();
              }

              @Override
              protected void onResume() {
                  super.onResume();
                  goImmersive();
              }

              @Override
              protected void onActivityResult(int requestCode, int resultCode, Intent data) {
                  super.onActivityResult(requestCode, resultCode, data);
                  if (requestCode == PICK && uploadCb != null) {
                      Uri[] result = null;
                      if (resultCode == RESULT_OK && data != null) {
                          String s = data.getDataString();
                          if (s != null) result = new Uri[]{Uri.parse(s)};
                      }
                      uploadCb.onReceiveValue(result);
                      uploadCb = null;
                  }
              }

              @Override
              public void onBackPressed() {
                  // Block back button
              }
          }
          JAVAEOF

      - name: Build APK
        working-directory: android
        run: |
          gradle wrapper --gradle-version 8.4
          chmod +x gradlew
          ./gradlew assembleRelease --no-daemon --stacktrace

      - name: Collect APK
        run: |
          APK=$(find android -name "app-release.apk" | head -1)
          cp "$APK" MagicClock.apk
          echo "âœ… $(du -h MagicClock.apk | cut -f1)"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: MagicClock
          path: MagicClock.apk

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.0
          name: Magic Clock v1.0.0
          files: MagicClock.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
